# Network penetration testing is one type of penetration testing or “pen test” that specifically targets a company’s entire computer network through the practice of ethical hacking.
from toolkit.models import TestLog, Project, TestResult, TestType, Vulnerability
from scapy.all import *
from paramiko import SSHClient, AutoAddPolicy
from socket import gethostbyname
import requests
import socket
from bs4 import BeautifulSoup
import os
import nmap
def test_network(project_id = 1):
    # run test
    project = Project.objects.get(id=project_id)
    test_type = TestType.objects.get(name='Network')
    test_log = TestLog.objects.create(project=project, test_type=test_type)
    test_log.save()
    # get project details
    target = project.target
    # get target IP address
    target_ip = gethostbyname(target)
    # get target hostname
    target_hostname = socket.gethostbyaddr(target_ip)
    # get target open ports
    nm = nmap.PortScanner()
    nm.scan(target, '1-1024')
    open_ports = nm[target]['tcp'].keys()
    # get target OS
    os = nm[target]['osmatch'][0]['name']
    # get target services
    services = nm[target]['tcp']
    # get target web server
    web_server = ''
    if 80 in open_ports:
        web_server = requests.get('http://' + target).headers['Server']
    # get target DNS server
    dns_server = ''
    if 53 in open_ports:
        dns_server = 'DNS Server'
    # get target mail server
    mail_server = ''
    if 25 in open_ports:
        mail_server = 'Mail Server'
    # get target FTP server
    ftp_server = ''
    if 21 in open_ports:
        ftp_server = 'FTP Server'
        
    # create test result
    test_result = TestResult.objects.create(test_log=test_log)
    test_result.save()
    # create vulnerability
    vulnerability = Vulnerability.objects.create(test_result=test_result)
    vulnerability.save()
    # save test results
    test_result.target_ip = target_ip
    test_result.target_hostname = target_hostname
    test_result.open_ports = open_ports
    test_result.os = os
    test_result.services = services
    test_result.web_server = web_server
    test_result.dns_server = dns_server
    test_result.mail_server = mail_server
    test_result.ftp_server = ftp_server
    test_result.save()
    
    return test_result
